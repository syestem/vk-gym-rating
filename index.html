<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Рейтинг посещаемости</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- VK Bridge -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

  <style>
    :root {
      --bg: #f5f6f8;
      --card: #ffffff;
      --text: #000000;
      --muted: #6d7885;
      --border: #e1e3e6;
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
    }

    h2 {
      margin: 0 0 4px;
      font-size: 20px;
    }

    .subtitle {
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    th {
      font-weight: 600;
      background: #f0f2f5;
    }

    td.name {
      text-align: left;
    }

    tr.top-1 { background: rgba(255, 215, 0, 0.15); }
    tr.top-2 { background: rgba(192, 192, 192, 0.15); }
    tr.top-3 { background: rgba(205, 127, 50, 0.15); }

    a {
      color: #2a5885;
      text-decoration: none;
    }
  </style>
</head>

<body>

<div class="card">
  <h2 id="title">Рейтинг посещаемости</h2>
  <div class="subtitle" id="month">Загрузка…</div>

  <table id="rating">
    <thead>
      <tr>
        <th>#</th>
        <th>Участник</th>
        <th>Зал</th>
        <th>Бассейн</th>
        <th>Итого</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  vkBridge.send('VKWebAppInit');

  const SHEET_URL =
    'https://docs.google.com/spreadsheets/d/1fz_CeBp5yXH3qwvgYGQXY77nHZXoq3JMn6BqPZQ--Og/export?format=csv';

  fetch(SHEET_URL)
    .then(r => r.text())
    .then(text => {
      text = text.replace(/^\uFEFF/, '');
      const lines = text.split(/\r?\n/);

      const tbody = document.querySelector('#rating tbody');
      const monthEl = document.getElementById('month');

      const data = [];
      let detectedMonth = '';

      for (let i = 0; i < lines.length; i++) {
        const cols = lines[i].split(',');

        // Поиск месяца вида "Февраль 2026"
        cols.forEach(c => {
          if (/^[А-ЯЁ][а-яё]+ \d{4}$/.test(c.trim())) {
            detectedMonth = c.trim();
          }
        });

        const vkUrl = cols[0]?.trim();
        if (!vkUrl || !vkUrl.startsWith('https://vk.com')) continue;

        data.push({
          vkUrl,
          name: cols[1]?.trim(),
          gym: Number(cols[2]),
          pool: Number(cols[3]),
          total: Number(cols[4])
        });
      }

      // Сортировка по Итого (убывание)
      data.sort((a, b) => b.total - a.total);

      // Заголовок месяца
      monthEl.textContent = detectedMonth
        ? `Период: ${detectedMonth}`
        : 'Период не указан';

      // Отрисовка
      data.forEach((row, index) => {
        const tr = document.createElement('tr');

        if (index === 0) tr.classList.add('top-1');
        if (index === 1) tr.classList.add('top-2');
        if (index === 2) tr.classList.add('top-3');

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td class="name">
            <a href="${row.vkUrl}" target="_blank">${row.name}</a>
          </td>
          <td>${row.gym}</td>
          <td>${row.pool}</td>
          <td><b>${row.total}</b></td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => console.error(err));
</script>

</body>
</html>
