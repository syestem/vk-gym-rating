<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Рейтинг посещаемости</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

  <style>
    :root {
      --bg: #f5f6f8;
      --card: #ffffff;
      --text: #000000;
      --muted: #6d7885;
      --border: #e1e3e6;
    }

    body.dark {
      --bg: #141414;
      --card: #1f1f1f;
      --text: #ffffff;
      --muted: #aaaaaa;
      --border: #2c2c2c;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    td.name { text-align: left; }

    tr.top-1 { background: rgba(255,215,0,.15); }
    tr.top-2 { background: rgba(192,192,192,.15); }
    tr.top-3 { background: rgba(205,127,50,.15); }

    a { color: #2a5885; text-decoration: none; }
    body.dark a { color: #71a7ff; }
  </style>
</head>

<body>

<div class="card">
  <h2>Рейтинг посещаемости</h2>

  <div class="controls">
    <select id="monthSelect"></select>
    <select id="facultySelect">
      <option value="all">Все факультеты</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Участник</th>
        <th>Факультет</th>
        <th>Зал</th>
        <th>Бассейн</th>
        <th>Итого</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  vkBridge.send('VKWebAppInit');

  vkBridge.subscribe(e => {
    if (e.detail.type === 'VKWebAppUpdateConfig') {
      document.body.classList.toggle(
        'dark',
        e.detail.data.scheme.includes('dark')
      );
    }
  });

  const SHEET_ID = '1fz_CeBp5yXH3qwvgYGQXY77nHZXoq3JMn6BqPZQ--Og';

  const MONTHS = {
    'Февраль 2026': 2092021629,
    'Январь 2026': 1935263010
  };

  const monthSelect = document.getElementById('monthSelect');
  const facultySelect = document.getElementById('facultySelect');
  const tbody = document.getElementById('tbody');

  Object.keys(MONTHS).forEach(m => {
    const o = document.createElement('option');
    o.value = m;
    o.textContent = m;
    monthSelect.appendChild(o);
  });

  monthSelect.addEventListener('change', loadMonth);
  facultySelect.addEventListener('change', render);

  let currentData = [];

  function loadMonth() {
    const month = monthSelect.value;
    const gid = MONTHS[month];

    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`)
      .then(r => r.text())
      .then(text => {
        text = text.replace(/^\uFEFF/, '');
        currentData = [];
        const faculties = new Set();

        text.split(/\r?\n/).slice(1).forEach(line => {
          if (!line.trim()) return;
          const c = line.split(',');

          if (!c[0]?.startsWith('https://vk.com')) return;

          currentData.push({
            vkUrl: c[0],
            name: c[1],
            faculty: c[2],
            gym: Number(c[3]),
            pool: Number(c[4]),
            total: Number(c[5])
          });

          faculties.add(c[2]);
        });

        facultySelect.innerHTML = '<option value="all">Все факультеты</option>';
        faculties.forEach(f => {
          const o = document.createElement('option');
          o.value = f;
          o.textContent = f;
          facultySelect.appendChild(o);
        });

        render();
      });
  }

  function render() {
    tbody.innerHTML = '';
    const faculty = facultySelect.value;

    let data = [...currentData];
    if (faculty !== 'all') {
      data = data.filter(r => r.faculty === faculty);
    }

    data.sort((a, b) => b.total - a.total);

    data.forEach((r, i) => {
      const tr = document.createElement('tr');
      if (i === 0) tr.classList.add('top-1');
      if (i === 1) tr.classList.add('top-2');
      if (i === 2) tr.classList.add('top-3');

      tr.innerHTML = `
        <td>${i + 1}</td>
        <td class="name"><a href="${r.vkUrl}" target="_blank">${r.name}</a></td>
        <td>${r.faculty}</td>
        <td>${r.gym}</td>
        <td>${r.pool}</td>
        <td><b>${r.total}</b></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // старт — первый месяц
  loadMonth();
</script>

</body>
</html>
