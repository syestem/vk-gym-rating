<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–π—Ç–∏–Ω–≥ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

  <style>
    :root {
      --bg: #f5f6f8;
      --card: #ffffff;
      --text: #000000;
      --muted: #6d7885;
      --border: #e1e3e6;
    }

    body.dark {
      --bg: #141414;
      --card: #1f1f1f;
      --text: #ffffff;
      --muted: #aaaaaa;
      --border: #2c2c2c;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
    }

    h2 {
      margin: 0 0 6px;
      font-size: 20px;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    th {
      background: rgba(0,0,0,0.04);
    }

    td.name {
      text-align: left;
    }

    tr.top-1 { background: rgba(255,215,0,.15); }
    tr.top-2 { background: rgba(192,192,192,.15); }
    tr.top-3 { background: rgba(205,127,50,.15); }

    a { color: #2a5885; text-decoration: none; }
    body.dark a { color: #71a7ff; }
  </style>
</head>

<body>

<div class="card">
  <h2>–†–µ–π—Ç–∏–Ω–≥ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h2>

  <div class="controls">
    <select id="monthSelect"></select>
    <select id="facultySelect">
      <option value="all">–í—Å–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
        <th>–§–∞–∫—É–ª—å—Ç–µ—Ç</th>
        <th>–ó–∞–ª</th>
        <th>–ë–∞—Å—Å–µ–π–Ω</th>
        <th>–ò—Ç–æ–≥–æ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  vkBridge.send('VKWebAppInit');

  // üîπ –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê VK
  vkBridge.subscribe(e => {
    if (e.detail.type === 'VKWebAppUpdateConfig') {
      const scheme = e.detail.data.scheme;
      document.body.classList.toggle('dark', scheme.includes('dark'));
    }
  });

  const SHEET_ID = '1fz_CeBp5yXH3qwvgYGQXY77nHZXoq3JMn6BqPZQ--Og';
  const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

  let allData = [];
  let months = new Set();
  let faculties = new Set();

  fetch(SHEET_URL)
    .then(r => r.text())
    .then(text => {
      text = text.replace(/^\uFEFF/, '');
      const lines = text.split(/\r?\n/);

      lines.forEach(line => {
        const c = line.split(',');

        // –º–µ—Å—è—Ü –≤–∏–¥–∞ "–§–µ–≤—Ä–∞–ª—å 2026"
        c.forEach(v => {
          if (/^[–ê-–Ø–Å][–∞-—è—ë]+ \d{4}$/.test(v.trim())) {
            months.add(v.trim());
          }
        });

        const vkUrl = c[0]?.trim();
        if (!vkUrl?.startsWith('https://vk.com')) return;

        const row = {
          vkUrl,
          name: c[1]?.trim(),
          faculty: c[2]?.trim(),
          gym: Number(c[3]),
          pool: Number(c[4]),
          total: Number(c[5])
        };

        allData.push(row);
        faculties.add(row.faculty);
      });

      initControls();
      render();
    });

  function initControls() {
    const monthSelect = document.getElementById('monthSelect');
    months.forEach(m => {
      const o = document.createElement('option');
      o.value = m;
      o.textContent = m;
      monthSelect.appendChild(o);
    });

    const facultySelect = document.getElementById('facultySelect');
    faculties.forEach(f => {
      const o = document.createElement('option');
      o.value = f;
      o.textContent = f;
      facultySelect.appendChild(o);
    });

    monthSelect.addEventListener('change', render);
    facultySelect.addEventListener('change', render);
  }

  function render() {
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    const faculty = document.getElementById('facultySelect').value;

    let data = [...allData];
    if (faculty !== 'all') {
      data = data.filter(r => r.faculty === faculty);
    }

    data.sort((a, b) => b.total - a.total);

    data.forEach((r, i) => {
      const tr = document.createElement('tr');
      if (i === 0) tr.classList.add('top-1');
      if (i === 1) tr.classList.add('top-2');
      if (i === 2) tr.classList.add('top-3');

      tr.innerHTML = `
        <td>${i + 1}</td>
        <td class="name"><a href="${r.vkUrl}" target="_blank">${r.name}</a></td>
        <td>${r.faculty}</td>
        <td>${r.gym}</td>
        <td>${r.pool}</td>
        <td><b>${r.total}</b></td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>

</body>
</html>
